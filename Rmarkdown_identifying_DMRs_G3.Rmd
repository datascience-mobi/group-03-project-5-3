---
title: "Identifying DMRs G3"
author: "Leo Burmedi, Pierre De Marinis, Konstantin Fischer, Daniel Ãœrge"
date: "6/10/2019"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

# Introduction

> Differentially methylated regions (DMRs) ...

## Loading the data and naming the frames.
```{r, echo=TRUE} 
AML_Mono_list <- readRDS("~/Heidelberg/Uni/FS4 2019/Bioinfo/AMLvsMono/AML_Mono_list.RDS")
input_data <- AML_Mono_list
genes_data_framexy <- input_data$genes
promoters_data_framexy <- input_data$promoters
cpgislands_data_frame <- input_data$cpgislands
tiling_data_frame <- input_data$tiling
remove(tiling_data_frame, cpgislands_data_frame, input_data, AML_Mono_list)
```

> From these datasets only the genes and the promoters will be relevant for the analysis, so we can remove the others. The reason is that only promoters and genes  directly influence the gene expression for certain and in the end we want to find differences in the gene expression between the two cohorts.   

# Quality control

> The goal of Qualtity control is to make the dataset as suited as possible for the analyis. This includes:Removing uncessary variables, getting rid NAs, removing information that can produce fallicous results.

## Removing chromosome X and Y.

> Chromosome X is removed because of hypermethylation and chromosome Y because of lack of male patients.

```{r, echo = TRUE}
    genes_data_frame <- data.frame(genes_data_framexy[!(genes_data_framexy$Chromosome == "chrX" | genes_data_framexy$Chromosome == "chrY"),])
    promoters_data_frame <-     data.frame(promoters_data_framexy[!(promoters_data_framexy$Chromosome == "chrX" | promoters_data_framexy$Chromosome == "chrY"),])
    remove(genes_data_framexy, promoters_data_framexy)
```

## Distribution of beta values by healty and AML patients.

> First we need to check if we can find DMRs at all. Finding DMRs is only possible if the distributions of beta values differ between AML and healty patients so we need to check this.  

```{r, echo = TRUE} 
    g_AML_bedall <- data.frame(Beta = c(t(na.omit(genes_data_frame[,11:20]))))
    g_Mono_bedall <- data.frame(Beta = c(t(na.omit(genes_data_frame[,21:30]))))
    p_AML_bedall <- data.frame(Beta = c(t(na.omit(promoters_data_frame[,11:20]))))
    p_Mono_bedall <- data.frame(Beta = c(t(na.omit(promoters_data_frame[,21:30]))))
```

#### Distribution of all beta values by AML or Mono patiens in the genes and prmoters dataset.
```{r, echo = TRUE}
par(mfrow=c(1, 2))    
    hist(g_Mono_bedall$Beta, main = "Distribution beta Mono genes", xlab = "beta value", col = "forestgreen", breaks = 50, ylim = c(0, 80000))
    hist(g_AML_bedall$Beta, main = "Distribution beta AML genes", xlab = "beta value", col = "red", breaks = 50)
```  

```{r, echo = TRUE}
    par(mfrow=c(1, 2))    
    hist(p_Mono_bedall$Beta, main = "Distribution beta Mono promoters", xlab = "beta value", col = "forestgreen", breaks = 50, ylim = c(0, 80000))
    hist(p_AML_bedall$Beta, main = "Distribution beta AML promoters", xlab = "beta value", col = "red", breaks = 50)
```  

> It can be seen for both promoters and genes, that the two plots have a slightly different distribution. This confirms the assumption that we might find DMRs for both datasets. 

## Removing unnecessary variables

> For the analysis we only need the beta and the coverage values of the patients.

```{r, echo=TRUE}
    g_patients <- data.frame(genes_data_frame[11:50])
    p_patients <- data.frame(promoters_data_frame[11:50])
```

## Setting coverage thresholds and handling NAs

> If the coverage values is too low that means the given sequence wasn't properly amplified. If it is too high however that might be due to the overlap of repeated sequences.  This can render our analysis unreliable so we need to find sensible thresholds. The lower coverage threshold was set by 25 based on literature. For the higher however we came up with the solution to find the value where we would loose the lowest percentage of data by loosing the highest percentage of coverage values. To check if this is even possible we made two plots to evalueate the function. Since the two datasets have a different distribution we need to find seperate upper thresholds.

> Once we find the threshold we will convert all beta values with an unrelaible corresponding coverage value to NAs. Next we will remove all lines with a more than 3 NAs for one cohort.

```{r,  echo=TRUE} 
    # Creating data frames with all coverage values by genes and promoters
    g_coverage_all <- data.frame(Coverage = c(t(genes_data_frame[,31:50])))
    p_coverage_all <- data.frame(Coverage = c(t(promoters_data_frame[,31:50])))
```

### Drawing a "if we make this the maximum coverage value we keep this % of objects" plot.

```{r, echo = TRUE}
    Y = seq(0, 200000, 1)
    Q = ecdf(g_coverage_all$Coverage) (Y)
    plot(Y, Q, type = "n", main = "Quantiles for coverage values by genes", xlab = "Coverage value", ylab = "Quantile")
    lines(Y, Q)
```


```{r, echo = TRUE}
    Y = seq(0, 200000, 1)
    Q = ecdf(p_coverage_all$Coverage) (Y)
    plot(Y, Q, type = "n", main = "Quantiles for coverage values by promoters", xlab = "Coverage value", ylab = "Quantile")
    lines(Y, Q)
```

> The curves for both datasets have a very rapid increase by lower values and then  functions. So this confirms that we can use our above mentioned method and loose a very high percentage of data by cutting at a relatively low value and we can proceed with the anlyis. 

### Finding the upper threshold

> For finding the upper thresfold we used the hyperloop. The hyperloop calculates the amount of lines, which would remain if we were to cut at a given coverage value. 
